<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Configuration - The Plonky3 recursion book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Plonky3 recursion book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="configuration"><a class="header" href="#configuration">Configuration</a></h1>
<p>This section covers the parameters you need to choose when setting up recursive verification.</p>
<h2 id="field-selection"><a class="header" href="#field-selection">Field selection</a></h2>
<p>The library currently supports two base fields:</p>
<div class="table-wrapper"><table><thead><tr><th>Field</th><th>Modulus</th><th>Bits</th><th>Status</th></tr></thead><tbody>
<tr><td><strong>KoalaBear</strong></td><td><code>0x7F000001</code></td><td>31</td><td>Recommended</td></tr>
<tr><td><strong>BabyBear</strong></td><td><code>0x78000001</code></td><td>31</td><td>Fully supported</td></tr>
</tbody></table>
</div>
<p>All fields support degree-4 binomial extensions (<code>BinomialExtensionField&lt;F, 4&gt;</code>), which is a currently
fixed parameter for the recursion stack, with plans to lift it to a runtime parameter in the future.</p>
<h2 id="fri-parameters"><a class="header" href="#fri-parameters">FRI parameters</a></h2>
<p>FRI parameters control the trade-off between proof size, verifier cost, and security level.</p>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th>Typical value</th><th>Effect</th></tr></thead><tbody>
<tr><td><code>log_blowup</code></td><td>3</td><td>LDE blowup factor (<code>2^log_blowup</code>). Higher = more redundancy, fewer queries needed.</td></tr>
<tr><td><code>max_log_arity</code></td><td>4</td><td>Maximum folding factor per FRI round (<code>2^max_log_arity</code>). Controls how quickly polynomial degree reduces.</td></tr>
<tr><td><code>log_final_poly_len</code></td><td>5</td><td>Degree of the final polynomial after folding. Smaller = more folding rounds but simpler final check.</td></tr>
<tr><td><code>query_pow_bits</code></td><td>16</td><td>Proof-of-work bits during the query phase. Higher = fewer queries needed for same security.</td></tr>
<tr><td><code>commit_pow_bits</code></td><td>0</td><td>Proof-of-work bits during the commit phase. Usually 0.</td></tr>
<tr><td><code>cap_height</code></td><td>0</td><td>Height at which Merkle trees are truncated for commitments. 0 = single root hash.</td></tr>
</tbody></table>
</div>
<h3 id="security-level"><a class="header" href="#security-level">Security level</a></h3>
<p>The number of FRI queries is derived as:</p>
<pre><code>num_queries = (target_security_bits - query_pow_bits) / log_blowup
</code></pre>
<p>With default parameters (<code>target = 100 bits</code>, <code>query_pow_bits = 16</code>, <code>log_blowup = 3</code>):</p>
<pre><code>num_queries = (100 - 16) / 3 = 28
</code></pre>
<p>See related section in the <strong><a href="./../advanced_topics/soundness.html">Soundness and Security</a></strong> chapter for a
more thorough analysis of the security estimate in the light of recent findings against the underlying
assumptions used in these heuristics.</p>
<h3 id="intermediate-layer-relaxation"><a class="header" href="#intermediate-layer-relaxation">Intermediate layer relaxation</a></h3>
<p>For intermediate recursive layers (not the final one), soundness requirements compose, so relaxed parameters can be used:</p>
<ul>
<li><code>query_pow_bits = 20</code>, <code>num_queries = 26</code> — saves 2 queries worth of in-circuit work</li>
<li><code>query_pow_bits = 24</code>, <code>num_queries = 25</code> — more aggressive, suitable for deeply nested layers</li>
</ul>
<p>The outermost (final) layer should use full-strength parameters.</p>
<h3 id="friverifierparams"><a class="header" href="#friverifierparams">FriVerifierParams</a></h3>
<p>The recursion circuit uses <code>FriVerifierParams</code> to know the FRI structure without accessing the native <code>FriParameters</code> directly:</p>
<pre><code class="language-rust ignore">let fri_verifier_params = FriVerifierParams::with_mmcs(
    log_blowup,
    log_final_poly_len,
    commit_pow_bits,
    query_pow_bits,
    poseidon2_config,
);</code></pre>
<p>This is stored in your config wrapper and returned via <code>FriRecursionConfig::pcs_verifier_params()</code>.</p>
<h2 id="poseidon2-configuration"><a class="header" href="#poseidon2-configuration">Poseidon2 configuration</a></h2>
<p>The <code>Poseidon2Config</code> enum selects the hash function parameters for in-circuit hashing (MMCS verification and Fiat-Shamir):</p>
<div class="table-wrapper"><table><thead><tr><th>Config</th><th>Field</th><th>D</th><th>WIDTH</th><th>RATE</th></tr></thead><tbody>
<tr><td><code>BabyBearD4Width16</code></td><td>BabyBear</td><td>4</td><td>16</td><td>8</td></tr>
<tr><td><code>BabyBearD1Width16</code></td><td>BabyBear</td><td>1</td><td>16</td><td>8</td></tr>
<tr><td><code>BabyBearD4Width24</code></td><td>BabyBear</td><td>4</td><td>24</td><td>12</td></tr>
<tr><td><code>KoalaBearD4Width16</code></td><td>KoalaBear</td><td>4</td><td>16</td><td>8</td></tr>
<tr><td><code>KoalaBearD1Width16</code></td><td>KoalaBear</td><td>1</td><td>16</td><td>8</td></tr>
<tr><td><code>KoalaBearD4Width24</code></td><td>KoalaBear</td><td>4</td><td>24</td><td>12</td></tr>
</tbody></table>
</div>
<p>For standard recursive verification, use the <code>D4Width16</code> variant matching your field. The <code>D1</code> variants use base field challenges (lower overhead per duplexing, but different security trade-offs). The <code>Width24</code> variants use a wider permutation for more efficient hashing.</p>
<p>The <code>Poseidon2Config</code> must be consistent between:</p>
<ul>
<li>The <code>FriRecursionBackend</code> constructor</li>
<li>The <code>FriVerifierParams</code></li>
<li>The Poseidon2 permutation enabled on the <code>CircuitBuilder</code></li>
</ul>
<h2 id="table-packing"><a class="header" href="#table-packing">Table packing</a></h2>
<p><code>TablePacking</code> controls how circuit operations are distributed across table lanes. Each lane adds columns to a table; more lanes means shorter (fewer rows) but wider (more columns) tables.</p>
<pre><code class="language-rust ignore">TablePacking::new(witness_lanes, public_lanes, alu_lanes)</code></pre>
<div class="table-wrapper"><table><thead><tr><th>Parameter</th><th>Controls</th><th>Trade-off</th></tr></thead><tbody>
<tr><td><code>witness_lanes</code></td><td>Witness table width</td><td>More lanes → fewer rows, but wider table</td></tr>
<tr><td><code>public_lanes</code></td><td>Public input table width</td><td>Often the bottleneck for row count</td></tr>
<tr><td><code>alu_lanes</code></td><td>ALU (add/mul) table width</td><td>Most operations land here</td></tr>
</tbody></table>
</div>
<p>The total row count of each table is <code>ceil(num_ops / num_lanes)</code>, padded to the next power of two. The <strong>maximum table height</strong> across all tables determines the FRI polynomial degree and dominates proving cost.</p>
<h3 id="choosing-packing-values"><a class="header" href="#choosing-packing-values">Choosing packing values</a></h3>
<p>The goal is to balance table heights so no single table forces a large power-of-two padding.</p>
<p><strong>Example</strong> — a recursive verification circuit with ~65K witness ops, ~43K public ops, ~60K ALU ops:</p>
<div class="table-wrapper"><table><thead><tr><th>Packing</th><th>Max height</th><th>Notes</th></tr></thead><tbody>
<tr><td><code>(5, 1, 3)</code></td><td>2^16 = 65,536</td><td>Public table (43K/1 = 43K rows) forces 2^16</td></tr>
<tr><td><code>(5, 2, 3)</code></td><td>2^15 = 32,768</td><td>Public drops to 21.5K, halving the max</td></tr>
<tr><td><code>(5, 3, 3)</code></td><td>2^15 = 32,768</td><td>Public at 14.3K, ALU at 20K — both fit in 2^15</td></tr>
<tr><td><code>(8, 4, 4)</code></td><td>2^14 = 16,384</td><td>Everything fits, but tables are very wide</td></tr>
</tbody></table>
</div>
<p>Halving the max table height cuts FRI proving time by roughly 40-50% (one fewer folding round, half the polynomial size).</p>
<p>Use <code>.with_fri_params(log_final_poly_len, log_blowup)</code> to set minimum row counts:</p>
<pre><code class="language-rust ignore">let packing = TablePacking::new(5, 2, 3)
    .with_fri_params(log_final_poly_len, log_blowup);</code></pre>
<h3 id="layer-specific-packing"><a class="header" href="#layer-specific-packing">Layer-specific packing</a></h3>
<p>The first recursive layer (verifying the original proof) often has a different operation distribution than subsequent layers. It's common to use different packing per layer:</p>
<pre><code class="language-rust ignore">let packing = if layer == 1 {
    TablePacking::new(1, 1, 1)
} else {
    TablePacking::new(5, 1, 3)
}.with_fri_params(log_final_poly_len, log_blowup);</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../user_guide/aggregation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../user_guide/public_inputs.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../user_guide/aggregation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../user_guide/public_inputs.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
