name: Auto-label issues from form checkboxes (and set perf milestone)

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  issues: write

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            // Re-fetch to avoid stale payload
            const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number });
            const body = issue.body || "";

            // Matches lines like: - [x] perf   (case-insensitive, allows trailing text)
            const isChecked = (name) => {
              const re = new RegExp(`^\\s*-\\s*\\[[xX]\\]\\s*${name}\\b`, "im");
              return re.test(body);
            };

            const wantsPerf = isChecked("perf");
            const wantsNeedsRfc = isChecked("needs-rfc");

            // --- label sync (preserve existing labels) ---
            const labels = new Set((issue.labels || []).map(l => l.name));
            const ensure = (name, want) => (want ? labels.add(name) : labels.delete(name));

            ensure("perf", wantsPerf);
            ensure("needs-rfc", wantsNeedsRfc);

            await github.rest.issues.setLabels({
              owner, repo, issue_number,
              labels: Array.from(labels),
            });

            // --- milestone sync for perf ---
            const targetMilestoneTitle = "Performance Engineering";

            const milestones = await github.paginate(github.rest.issues.listMilestones, {
              owner, repo, state: "open", per_page: 100,
            });

            const target = milestones.find(m => m.title === targetMilestoneTitle);
            if (!target) {
              core.warning(`Milestone "${targetMilestoneTitle}" not found (open).`);
              return;
            }

            const currentMilestone = issue.milestone;
            const currentTitle = currentMilestone ? currentMilestone.title : null;

            if (wantsPerf) {
              if (!currentMilestone) {
                await github.rest.issues.update({
                  owner, repo, issue_number,
                  milestone: target.number,
                });
              } else if (currentTitle !== targetMilestoneTitle) {
                // don't overwrite other milestones
                core.info(`Issue already has milestone "${currentTitle}". Not overwriting.`);
              }
            } else {
              if (currentMilestone && currentTitle === targetMilestoneTitle) {
                await github.rest.issues.update({
                  owner, repo, issue_number,
                  milestone: null,
                });
              }
            }
